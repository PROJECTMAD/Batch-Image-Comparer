<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Comparer (with Albums & Viewer)</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #ffffff;
            --bg-secondary-color: #f0f0f0;
            --bg-tertiary-color: #f9f9f9;
            --text-color: #333333;
            --text-secondary-color: #555555;
            --border-color: #e0e0e0;
            --border-light-color: #eeeeee;
            --accent-color: #007bff;
            --accent-hover-color: #0056b3;
            --success-color: #28a745;
            --success-hover-color: #218838;
            --error-color: #dc3545;
            --box-shadow-color: rgba(0,0,0,0.1);
            --input-bg-color: #ffffff;
            --input-border-color: #cccccc;
            --button-text-color: #ffffff;
            --tab-inactive-border: transparent;
            --spinner-light-color: #f3f3f3;
            --lightbox-bg: rgba(0,0,0,0.85);
            --lightbox-nav-bg: rgba(50,50,50,0.6);
            --lightbox-nav-hover-bg: rgba(80,80,80,0.8);
        }

        body.dark-theme {
            --bg-color: #1e1e1e;
            --bg-secondary-color: #2a2a2a;
            --bg-tertiary-color: #252525;
            --text-color: #e0e0e0;
            --text-secondary-color: #b0b0b0;
            --border-color: #444444;
            --border-light-color: #383838;
            --accent-color: #0088ff; /* Slightly brighter blue for dark theme */
            --accent-hover-color: #0066cc;
            --success-color: #30c355;
            --success-hover-color: #26a245;
            --error-color: #ff4c5d;
            --box-shadow-color: rgba(0,0,0,0.3);
            --input-bg-color: #333333;
            --input-border-color: #555555;
            --button-text-color: #e0e0e0; /* Changed to a lighter gray for better contrast on dark buttons */
            --tab-inactive-border: transparent;
            --spinner-light-color: #444444;
            --lightbox-bg: rgba(10,10,10,0.9);
            --lightbox-nav-bg: rgba(30,30,30,0.7);
            --lightbox-nav-hover-bg: rgba(50,50,50,0.9);
        }

        /* --- GENERAL STYLES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 20px;
            background-color: var(--bg-secondary-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 16px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px var(--box-shadow-color);
            width: 98%;
            max-width: 1400px;
            transition: background-color 0.3s;
        }

        h1, h2 {
            text-align: center;
            color: var(--text-color);
        }
        h2 { margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-light-color); padding-bottom: 10px;}

        /* Theme Toggle Button */
        #themeToggleButton {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 12px;
            background-color: var(--bg-tertiary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 1000; /* Ensure it's above most content but can be covered by lightbox modal content if necessary */
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        #themeToggleButton:hover {
            background-color: var(--accent-color);
            color: var(--button-text-color);
        }


        /* Tabs for switching views */
        .tab-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--text-secondary-color);
            font-size: 1.1em;
            border-bottom: 3px solid var(--tab-inactive-border);
            margin-bottom: -1px; /* Align with container border */
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .tab-button.active {
            border-bottom-color: var(--accent-color);
            font-weight: bold;
            color: var(--accent-color);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }


        /* Album Management & Selection */
        .album-form-container, .album-selection-container {
            background-color: var(--bg-tertiary-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color);
        }
        .form-group input[type="text"], .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }

        .form-button, .controls button {
            padding: 10px 20px;
            font-size: 1em;
            color: var(--button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .form-button { background-color: var(--success-color); }
        .form-button:hover { background-color: var(--success-hover-color); }
        .controls button { background-color: var(--accent-color); }
        .controls button:hover:not(:disabled) { background-color: var(--accent-hover-color); }
        .controls button:disabled { background-color: var(--text-secondary-color); cursor: not-allowed; opacity: 0.7; }

        .status-message { margin-top: 10px; font-weight: bold; min-height: 1.2em; }
        .status-success { color: var(--success-color); }
        .status-error { color: var(--error-color); }

        #albumList {
            list-style-type: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
        }
        #albumList li {
            padding: 10px;
            border-bottom: 1px solid var(--border-light-color);
            cursor: pointer;
            display: flex;
            align-items: center; /* Align checkbox with text better */
            transition: background-color 0.2s;
        }
        #albumList li:last-child { border-bottom: none; }
        #albumList li:hover { background-color: var(--bg-secondary-color); }
        #albumList li input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); accent-color: var(--accent-color); flex-shrink: 0; }
        .album-item-details { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; } /* Allow details to take space and hide overflow */
        .album-item-title { font-weight: bold; color: var(--text-color); }
        
        .album-item-desc {
            font-size: 0.9em;
            color: var(--text-secondary-color);
            margin-top: 3px;
            white-space: normal; /* Allow wrapping */
            word-break: break-word;
            /* CSS for initial truncation to N lines */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Show 2 lines initially */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 3.6em; /* fallback for browsers not supporting -webkit-line-clamp, approx 2 lines for 0.9em font */
            transition: max-height 0.3s ease-out, -webkit-line-clamp 0.3s ease-out;
        }

        .album-item-desc.expanded {
            -webkit-line-clamp: unset; /* Remove line clamping */
            max-height: 500px; /* Allow it to grow */
            white-space: pre-wrap; /* Preserve newlines from original description in expanded view */
            display: block; /* Override -webkit-box for full content display */
        }

        .album-item-count { font-size: 0.8em; color: var(--text-secondary-color); margin-left: auto; padding-left: 10px; flex-shrink: 0;}

        /* Comparison Area */
        .controls { display: flex; justify-content: center; align-items: center; margin: 20px 0; gap: 15px;}
        #imageIndicator { font-size: 1.1em; font-weight: bold; min-width: 100px; text-align: center; color: var(--text-color);}

        .image-comparison-area {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            border-top: 1px solid var(--border-light-color);
            padding-top: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        .image-pane {
            flex: 1 1 30%;
            min-width: 280px;
            max-width: 32%;
            text-align: center;
            background-color: var(--bg-tertiary-color);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            display: none;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .image-pane.active { display: block; }
        .image-pane h3 { margin-top: 0; color: var(--text-color); font-size: 1.1em; word-break: break-word; min-height: 2.4em;}
        .image-pane img {
            max-width: 100%;
            max-height: 350px;
            height: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            object-fit: contain;
            background-color: var(--bg-secondary-color);
            display: block;
            margin-left: auto;
            margin-right: auto;
            cursor: pointer; /* For lightbox */
            transition: border-color 0.3s, background-color 0.3s;
        }
        .image-pane .filename { margin-top: 8px; font-size: 0.85em; color: var(--text-secondary-color); word-break: break-all; min-height: 2.5em;}
        .error-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 100px;
            max-height: 350px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-secondary-color);
            color: var(--text-secondary-color);
            font-size: 0.9em;
            box-sizing: border-box;
            padding: 10px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .loading-spinner {
            border: 4px solid var(--spinner-light-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LIGHTBOX STYLES --- */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--lightbox-bg);
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 1001; /* Higher than theme toggle */
            padding: 20px; 
            box-sizing: border-box;
        }
        .lightbox-overlay.active { display: flex; }

        .lightbox-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .lightbox-image-container {
            width: 100%;
            height: calc(100% - 80px); 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.2s ease-out;
            transform-origin: center center;
            cursor: grab;
        }
        .lightbox-image.grabbing { cursor: grabbing; }

        .lightbox-close, .lightbox-nav {
            position: absolute;
            background-color: var(--lightbox-nav-bg);
            color: var(--button-text-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            user-select: none;
            z-index: 10; /* Above lightbox image container */
        }
        .lightbox-close:hover, .lightbox-nav:hover { background-color: var(--lightbox-nav-hover-bg); }

        .lightbox-close { top: 15px; right: 15px; }
        .lightbox-prev { left: 15px; top: 50%; transform: translateY(-50%); }
        .lightbox-next { right: 15px; top: 50%; transform: translateY(-50%); }

        .lightbox-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--lightbox-nav-bg);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 10;
        }
        .lightbox-controls button {
            background: none;
            border: none;
            color: var(--button-text-color);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        .lightbox-controls button:hover { opacity: 0.8; }
        .lightbox-zoom-level { color: var(--button-text-color); font-size: 0.9em; }

        .lightbox-caption {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--button-text-color);
            background-color: var(--lightbox-nav-bg);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            text-align: center;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 10;
        }
    </style>
</head>
<body>
    <button id="themeToggleButton" title="Toggle Theme">üåì</button>

    <div class="container">
        <h1>Batch Image Comparer</h1>

        <div class="tab-navigation">
            <button class="tab-button active" data-tab="compareTab">Compare Albums</button>
            <button class="tab-button" data-tab="manageTab">Manage Albums</button>
        </div>

        <div id="compareTab" class="tab-content active">
             <h2>Select Albums for Comparison (Up to 3)</h2>
            <div class="album-selection-container">
                <div id="albumListContainer">
                    <p id="albumListLoadingMsg">Loading albums...</p>
                    <div id="albumListLoadingSpinner" class="loading-spinner" style="display:none;"></div>
                    <ul id="albumList"></ul>
                </div>
                <button id="loadSelectedAlbumsBtn" class="form-button" style="margin-top:15px; background-color: var(--accent-color);">Load Selected for Comparison</button>
                <p id="selectionInfo" class="status-message"></p>
            </div>
            <div class="controls">
                <button id="prevBtn" disabled>¬´ Previous</button>
                <span id="imageIndicator">0 / 0</span>
                <button id="nextBtn" disabled>Next ¬ª</button>
            </div>
            <div class="image-comparison-area">
                <div id="imagePane1" class="image-pane">
                    <h3 id="albumTitle1">Album 1</h3>
                    <img id="img1" src="#" alt="Image from Album 1" style="display:none;">
                    <div id="img1Placeholder" class="error-placeholder">Select an album</div>
                    <p id="img1Name" class="filename">-</p>
                </div>
                <div id="imagePane2" class="image-pane">
                    <h3 id="albumTitle2">Album 2</h3>
                    <img id="img2" src="#" alt="Image from Album 2" style="display:none;">
                    <div id="img2Placeholder" class="error-placeholder">Select an album</div>
                    <p id="img2Name" class="filename">-</p>
                </div>
                <div id="imagePane3" class="image-pane">
                    <h3 id="albumTitle3">Album 3</h3>
                    <img id="img3" src="#" alt="Image from Album 3" style="display:none;">
                    <div id="img3Placeholder" class="error-placeholder">Select an album</div>
                    <p id="img3Name" class="filename">-</p>
                </div>
            </div>
        </div>

        <div id="manageTab" class="tab-content">
            <h2>Create New Album</h2>
            <div class="album-form-container">
                <div class="form-group">
                    <label for="albumTitle">Album Title:</label>
                    <input type="text" id="albumTitleInput" required>
                </div>
                <div class="form-group">
                    <label for="albumDescription">Description (Optional):</label>
                    <textarea id="albumDescriptionInput"></textarea>
                </div>
                <div class="form-group">
                    <label for="albumImageUrls">Image URLs (One per line, direct links):</label>
                    <textarea id="albumImageUrlsInput" placeholder="https://i.ibb.co/your-image1.jpg
https://another-host.com/pic.png" required></textarea>
                </div>
                <button id="createAlbumBtn" class="form-button">Create Album</button>
                <div id="createAlbumStatus" class="status-message"></div>
                <div id="createAlbumSpinner" class="loading-spinner" style="display:none;"></div>
            </div>
             <h2>Existing Albums</h2>
             <p style="text-align:center; color: var(--text-secondary-color);">(Switch to "Compare Albums" tab to refresh and see new albums)</p>
        </div>
    </div>

    <div id="lightboxOverlay" class="lightbox-overlay">
        <div class="lightbox-content">
            <span id="lightboxCaption" class="lightbox-caption">Image Title</span>
            <button id="lightboxClose" class="lightbox-close" title="Close (Esc)">√ó</button>
            <button id="lightboxPrev" class="lightbox-nav lightbox-prev" title="Previous Image (Left Arrow)">‚ùÆ</button>
            <button id="lightboxNext" class="lightbox-nav lightbox-next" title="Next Image (Right Arrow)">‚ùØ</button>
            <div class="lightbox-image-container">
                <img id="lightboxImage" class="lightbox-image" src="#" alt="Lightbox Image">
            </div>
            <div class="lightbox-controls">
                <button id="lightboxZoomOut" title="Zoom Out (-)">‚àí</button>
                <span id="lightboxZoomLevel" class="lightbox-zoom-level">100%</span>
                <button id="lightboxZoomIn" title="Zoom In (+)">+</button>
                <button id="lightboxZoomReset" title="Reset Zoom (0)">‚ü≥</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '681de6c372702c663ab3d4e9';
        const DB_URL = 'https://batchimagecomparer-1d67.restdb.io/rest/albums';
        const MAX_SELECTED_ALBUMS = 3;

        const themeToggleButton = document.getElementById('themeToggleButton');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const albumTitleInput = document.getElementById('albumTitleInput');
        const albumDescriptionInput = document.getElementById('albumDescriptionInput');
        const albumImageUrlsInput = document.getElementById('albumImageUrlsInput');
        const createAlbumBtn = document.getElementById('createAlbumBtn');
        const createAlbumStatus = document.getElementById('createAlbumStatus');
        const createAlbumSpinner = document.getElementById('createAlbumSpinner');
        const albumListUL = document.getElementById('albumList');
        const albumListLoadingMsg = document.getElementById('albumListLoadingMsg');
        const albumListLoadingSpinner = document.getElementById('albumListLoadingSpinner');
        const loadSelectedAlbumsBtn = document.getElementById('loadSelectedAlbumsBtn');
        const selectionInfo = document.getElementById('selectionInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const imageIndicator = document.getElementById('imageIndicator');

        const imagePanes = [
            { id: 'imagePane1', el: document.getElementById('imagePane1'), titleEl: document.getElementById('albumTitle1'), imgEl: document.getElementById('img1'), placeholderEl: document.getElementById('img1Placeholder'), nameEl: document.getElementById('img1Name'), urls: [], albumData: null },
            { id: 'imagePane2', el: document.getElementById('imagePane2'), titleEl: document.getElementById('albumTitle2'), imgEl: document.getElementById('img2'), placeholderEl: document.getElementById('img2Placeholder'), nameEl: document.getElementById('img2Name'), urls: [], albumData: null },
            { id: 'imagePane3', el: document.getElementById('imagePane3'), titleEl: document.getElementById('albumTitle3'), imgEl: document.getElementById('img3'), placeholderEl: document.getElementById('img3Placeholder'), nameEl: document.getElementById('img3Name'), urls: [], albumData: null }
        ];

        const lightboxOverlay = document.getElementById('lightboxOverlay');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxCaption = document.getElementById('lightboxCaption');
        const lightboxCloseBtn = document.getElementById('lightboxClose');
        const lightboxPrevBtn = document.getElementById('lightboxPrev');
        const lightboxNextBtn = document.getElementById('lightboxNext');
        const lightboxZoomInBtn = document.getElementById('lightboxZoomIn');
        const lightboxZoomOutBtn = document.getElementById('lightboxZoomOut');
        const lightboxZoomResetBtn = document.getElementById('lightboxZoomReset');
        const lightboxZoomLevel = document.getElementById('lightboxZoomLevel');

        let allAlbums = [];
        let selectedAlbumIds = [];
        let currentPairIndex = 0;
        let totalComparablePairs = 0;

        let lightboxCurrentScale = 1;
        const ZOOM_STEP = 0.2;
        const MAX_ZOOM = 5;
        const MIN_ZOOM = 0.2;
        let lightboxActivePanes = [];
        let lightboxCurrentImagePaneIndex = 0;
        let lightboxDragStartX, lightboxDragStartY;
        let lightboxIsDragging = false;
        let lightboxImgInitialX = 0; // Store initial translation for relative dragging
        let lightboxImgInitialY = 0;

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggleButton.textContent = '‚òÄÔ∏è';
                themeToggleButton.title = 'Switch to Light Theme';
            } else {
                document.body.classList.remove('dark-theme');
                themeToggleButton.textContent = 'üåì';
                themeToggleButton.title = 'Switch to Dark Theme';
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        themeToggleButton.addEventListener('click', toggleTheme);

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
                if (button.dataset.tab === 'compareTab' && allAlbums.length === 0) {
                    fetchAlbums();
                }
            });
        });

        async function apiCall(url, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json', 'x-apikey': API_KEY, 'cache-control': 'no-cache' }
            };
            if (body) options.body = JSON.stringify(body);
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`API Error: ${response.status} - ${errorData.message || 'Unknown error'}`);
                }
                return await response.json();
            } catch (error) { console.error('API Call Failed:', error); throw error; }
        }

        async function fetchAlbums() {
            albumListLoadingMsg.style.display = 'block';
            albumListLoadingMsg.textContent = 'Loading albums...';
            albumListLoadingSpinner.style.display = 'block';
            albumListUL.innerHTML = '';
            try {
                allAlbums = await apiCall(DB_URL);
                renderAlbumList();
                albumListLoadingMsg.style.display = 'none';
            } catch (error) {
                albumListLoadingMsg.textContent = `Error loading albums: ${error.message}`;
                albumListLoadingMsg.style.color = 'var(--error-color)';
            } finally { albumListLoadingSpinner.style.display = 'none'; }
        }

        async function createAlbum(albumData) {
            createAlbumStatus.textContent = '';
            createAlbumSpinner.style.display = 'block';
            try {
                const newAlbum = await apiCall(DB_URL, 'POST', albumData);
                createAlbumStatus.textContent = `Album "${newAlbum.title}" created successfully!`;
                createAlbumStatus.className = 'status-message status-success';
                albumTitleInput.value = ''; albumDescriptionInput.value = ''; albumImageUrlsInput.value = '';
            } catch (error) {
                createAlbumStatus.textContent = `Error creating album: ${error.message}`;
                createAlbumStatus.className = 'status-message status-error';
            } finally { createAlbumSpinner.style.display = 'none'; }
        }

        createAlbumBtn.addEventListener('click', () => {
            const title = albumTitleInput.value.trim();
            const description = albumDescriptionInput.value.trim();
            const urlsText = albumImageUrlsInput.value.trim();
            if (!title || !urlsText) {
                createAlbumStatus.textContent = 'Title and Image URLs are required.';
                createAlbumStatus.className = 'status-message status-error'; return;
            }
            const imageUrls = urlsText.split('\n').map(url => url.trim()).filter(url => url.length > 0 && (url.startsWith('http://') || url.startsWith('https://')));
            if (imageUrls.length === 0) {
                createAlbumStatus.textContent = 'Please provide at least one valid image URL.';
                createAlbumStatus.className = 'status-message status-error'; return;
            }
            createAlbum({ title, description, imageUrls });
        });

        function renderAlbumList() {
            albumListUL.innerHTML = '';
            if (allAlbums.length === 0) {
                albumListUL.innerHTML = '<li>No albums found. Create one in the "Manage Albums" tab.</li>'; return;
            }
            allAlbums.sort((a,b) => a.title.localeCompare(b.title)).forEach(album => {
                const li = document.createElement('li');
                li.dataset.albumId = album._id;
                li.setAttribute('role', 'option');
                li.setAttribute('aria-selected', selectedAlbumIds.includes(album._id) ? 'true' : 'false');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = selectedAlbumIds.includes(album._id);
                checkbox.setAttribute('tabindex', '-1'); // Not focusable by tab, li handles focus

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'album-item-details';
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'album-item-title';
                titleSpan.textContent = album.title;
                
                const descSpan = document.createElement('span');
                descSpan.className = 'album-item-desc';
                const fullDesc = album.description ? album.description : 'No description';
                descSpan.dataset.fullDescription = fullDesc; // Store original newlines for expanded
                descSpan.textContent = fullDesc; // CSS will handle initial truncation

                const countSpan = document.createElement('span');
                countSpan.className = 'album-item-count';
                countSpan.textContent = `(${album.imageUrls ? album.imageUrls.length : 0} images)`;

                detailsDiv.appendChild(titleSpan);
                detailsDiv.appendChild(descSpan);
                li.appendChild(checkbox);
                li.appendChild(detailsDiv);
                li.appendChild(countSpan);
                albumListUL.appendChild(li);

                li.addEventListener('click', (event) => {
                    if (event.target.tagName === 'INPUT' && event.target.type === 'checkbox') {
                         // Checkbox itself was clicked, let its default action (and our handleAlbumSelection) proceed
                    } else {
                        // Clicked on li or its children (not the checkbox directly)
                        checkbox.checked = !checkbox.checked; // Manually toggle checkbox state
                    }
                    li.setAttribute('aria-selected', checkbox.checked ? 'true' : 'false');
                    handleAlbumSelection(album._id, checkbox.checked);
                    
                    // Toggle description expansion, but only if the click wasn't on the checkbox itself
                    if (!(event.target.tagName === 'INPUT' && event.target.type === 'checkbox')) {
                         descSpan.classList.toggle('expanded');
                    }
                });
            });
        }

        function handleAlbumSelection(albumId, isChecked) {
            const listItem = albumListUL.querySelector(`li[data-album-id="${albumId}"]`);
            if (isChecked) {
                if (selectedAlbumIds.length < MAX_SELECTED_ALBUMS) {
                    if (!selectedAlbumIds.includes(albumId)) selectedAlbumIds.push(albumId); // Ensure no duplicates
                    if (listItem) listItem.setAttribute('aria-selected', 'true');
                } else if (!selectedAlbumIds.includes(albumId)) { // Trying to add a new one beyond limit
                    const checkbox = listItem ? listItem.querySelector('input[type="checkbox"]') : null;
                    if (checkbox) checkbox.checked = false;
                    if (listItem) listItem.setAttribute('aria-selected', 'false');
                    selectionInfo.textContent = `You can select a maximum of ${MAX_SELECTED_ALBUMS} albums.`;
                    selectionInfo.className = 'status-message status-error';
                    setTimeout(() => { selectionInfo.textContent = ''; }, 3000);
                }
            } else {
                selectedAlbumIds = selectedAlbumIds.filter(id => id !== albumId);
                if (listItem) listItem.setAttribute('aria-selected', 'false');
            }
            updateSelectionInfo();
        }

        function updateSelectionInfo() {
            const numSelected = selectedAlbumIds.length;
            selectionInfo.textContent = numSelected > 0 ? `${numSelected} album(s) selected.` : '';
            selectionInfo.className = numSelected > 0 ? 'status-message status-success' : 'status-message';
        }

        loadSelectedAlbumsBtn.addEventListener('click', () => {
            imagePanes.forEach(pane => {
                pane.urls = []; pane.albumData = null; pane.el.classList.remove('active');
                clearImagePane(pane, 'Select an album');
            });
            if (selectedAlbumIds.length === 0) {
                selectionInfo.textContent = 'Please select at least one album.';
                selectionInfo.className = 'status-message status-error';
                totalComparablePairs = 0; updateComparisonDisplay(); return;
            }
            selectionInfo.textContent = '';
            let activePaneIndex = 0;
            selectedAlbumIds.forEach(id => {
                const album = allAlbums.find(a => a._id === id);
                if (album && activePaneIndex < MAX_SELECTED_ALBUMS) {
                    const pane = imagePanes[activePaneIndex];
                    pane.urls = album.imageUrls || []; pane.albumData = album;
                    pane.el.classList.add('active'); pane.titleEl.textContent = album.title;
                    activePaneIndex++;
                }
            });
            for (let i = activePaneIndex; i < MAX_SELECTED_ALBUMS; i++) { imagePanes[i].el.classList.remove('active'); }
            prepareComparison();
        });

        function getFileNameFromUrl(url) {
            if (!url || typeof url !== 'string') return "Invalid URL";
            try { const path = new URL(url).pathname; const parts = path.split('/'); return decodeURIComponent(parts[parts.length - 1]) || url; }
            catch (e) { const parts = url.split('/'); return parts[parts.length - 1] || url; }
        }

        function prepareComparison() {
            const activePanesWithUrls = imagePanes.filter(p => p.albumData && p.urls.length > 0 && p.el.classList.contains('active'));
            totalComparablePairs = activePanesWithUrls.length > 0 ? Math.min(...activePanesWithUrls.map(p => p.urls.length)) : 0;
            currentPairIndex = 0;
            updateComparisonDisplay();
        }

        function clearImagePane(pane, message = "No image loaded") {
            pane.imgEl.src = "#"; pane.imgEl.style.display = 'none';
            pane.placeholderEl.textContent = message; pane.placeholderEl.style.display = 'flex';
            pane.nameEl.textContent = "-"; pane.imgEl.onclick = null;
        }

        function setImageForPane(pane, url, paneGlobalIndex) {
            if (!url) { clearImagePane(pane, pane.albumData ? 'No image at this index' : 'No album loaded'); return; }
            pane.imgEl.style.display = 'none'; pane.placeholderEl.textContent = 'Loading image...';
            pane.placeholderEl.style.display = 'flex'; pane.imgEl.src = url;
            pane.nameEl.textContent = getFileNameFromUrl(url);
            pane.imgEl.onload = () => {
                pane.imgEl.style.display = 'block'; pane.placeholderEl.style.display = 'none';
                pane.imgEl.onclick = () => openLightbox(paneGlobalIndex, currentPairIndex);
            };
            pane.imgEl.onerror = () => {
                pane.imgEl.style.display = 'none'; pane.placeholderEl.textContent = 'Error loading image.';
                pane.placeholderEl.style.display = 'flex';
                pane.nameEl.textContent = getFileNameFromUrl(url) + " (Error)"; pane.imgEl.onclick = null;
            };
        }

        function updateComparisonDisplay() {
            const activeLoadedPanes = imagePanes.filter(p => p.albumData && p.el.classList.contains('active'));
            const panesWithImagesForCurrentIndex = activeLoadedPanes.filter(p => p.urls && p.urls.length > currentPairIndex);

            if (totalComparablePairs > 0 && panesWithImagesForCurrentIndex.length > 0) {
                imageIndicator.textContent = `${currentPairIndex + 1} / ${totalComparablePairs}`;
                prevBtn.disabled = currentPairIndex === 0;
                nextBtn.disabled = currentPairIndex === totalComparablePairs - 1;
                activeLoadedPanes.forEach((pane, index) => {
                     setImageForPane(pane, pane.urls[currentPairIndex], imagePanes.indexOf(pane));
                });
            } else {
                imageIndicator.textContent = `0 / 0`; prevBtn.disabled = true; nextBtn.disabled = true;
                let singleAlbumNavPossible = false;
                activeLoadedPanes.forEach((pane) => {
                    if (pane.albumData && pane.urls.length > 0 && activeLoadedPanes.filter(p => p.urls && p.urls.length > 0).length === 1) {
                        setImageForPane(pane, pane.urls[currentPairIndex], imagePanes.indexOf(pane));
                        imageIndicator.textContent = `${currentPairIndex + 1} / ${pane.urls.length}`;
                        prevBtn.disabled = currentPairIndex === 0;
                        nextBtn.disabled = currentPairIndex >= pane.urls.length - 1; // Fix for single album next
                        singleAlbumNavPossible = true;
                    } else if (pane.albumData && (!pane.urls || pane.urls.length === 0)) { clearImagePane(pane, 'Album has no images');
                    } else if (pane.albumData) { clearImagePane(pane, 'No image for comparison');
                    } else { clearImagePane(pane, 'No album loaded'); }
                });
                if (!singleAlbumNavPossible) { prevBtn.disabled = true; nextBtn.disabled = true; }
            }
        }
        prevBtn.addEventListener('click', () => { if (currentPairIndex > 0) { currentPairIndex--; updateComparisonDisplay(); } });
        nextBtn.addEventListener('click', () => {
            let limit = totalComparablePairs;
            const activePanesWithImages = imagePanes.filter(p => p.albumData && p.urls && p.urls.length > 0 && p.el.classList.contains('active'));
            if (activePanesWithImages.length === 1) limit = activePanesWithImages[0].urls.length;
            if (currentPairIndex < limit - 1) { currentPairIndex++; updateComparisonDisplay(); }
        });

        function openLightbox(paneGlobalIndex, imageIdxInAlbum) {
            lightboxActivePanes = imagePanes.filter(p => p.el.classList.contains('active') && p.urls && p.urls.length > imageIdxInAlbum);
            if (lightboxActivePanes.length === 0) return;
            const startingPane = imagePanes[paneGlobalIndex];
            lightboxCurrentImagePaneIndex = lightboxActivePanes.indexOf(startingPane);
            if (lightboxCurrentImagePaneIndex === -1) lightboxCurrentImagePaneIndex = 0;
            updateLightboxImage();
            lightboxOverlay.classList.add('active');
            document.addEventListener('keydown', handleLightboxKeyPress);
            resetLightboxZoomAndPosition();
        }

        function closeLightbox() {
            lightboxOverlay.classList.remove('active');
            document.removeEventListener('keydown', handleLightboxKeyPress);
        }

        function updateLightboxImage() {
            if (lightboxActivePanes.length === 0 || lightboxCurrentImagePaneIndex < 0 || lightboxCurrentImagePaneIndex >= lightboxActivePanes.length) {
                closeLightbox(); return;
            }
            const currentPaneForLightbox = lightboxActivePanes[lightboxCurrentImagePaneIndex];
            const imageUrl = currentPaneForLightbox.urls[currentPairIndex];
            lightboxImage.src = imageUrl;
            lightboxCaption.textContent = `${currentPaneForLightbox.albumData.title} - ${getFileNameFromUrl(imageUrl)}`;
            resetLightboxZoomAndPosition();
        }
        
        function navigateLightbox(direction) {
            if (lightboxActivePanes.length <= 1) return;
            lightboxCurrentImagePaneIndex = (lightboxCurrentImagePaneIndex + direction + lightboxActivePanes.length) % lightboxActivePanes.length;
            updateLightboxImage();
        }

        function setLightboxZoom(scale) {
            lightboxCurrentScale = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, scale));
            // Keep current translation if zoomed, otherwise reset
            const currentTransform = lightboxImage.style.transform;
            const match = currentTransform.match(/translate\(([^,]+),([^)]+)\)/);
            let translateX = 0, translateY = 0;
            if (match && lightboxCurrentScale > 1) { // Only keep translation if zoomed
                translateX = parseFloat(match[1]);
                translateY = parseFloat(match[2]);
            }
            lightboxImage.style.transform = `scale(${lightboxCurrentScale}) translate(${translateX}px, ${translateY}px)`;
            lightboxZoomLevel.textContent = `${Math.round(lightboxCurrentScale * 100)}%`;
            lightboxImage.style.cursor = lightboxCurrentScale > 1 ? 'grab' : 'default';
        }

        function resetLightboxZoomAndPosition() {
            lightboxCurrentScale = 1;
            lightboxImage.style.transform = 'scale(1) translate(0px, 0px)';
            lightboxZoomLevel.textContent = '100%';
            lightboxImage.style.cursor = 'default';
        }

        lightboxCloseBtn.addEventListener('click', closeLightbox);
        lightboxPrevBtn.addEventListener('click', () => navigateLightbox(-1));
        lightboxNextBtn.addEventListener('click', () => navigateLightbox(1));
        lightboxZoomInBtn.addEventListener('click', () => setLightboxZoom(lightboxCurrentScale + ZOOM_STEP));
        lightboxZoomOutBtn.addEventListener('click', () => setLightboxZoom(lightboxCurrentScale - ZOOM_STEP));
        lightboxZoomResetBtn.addEventListener('click', resetLightboxZoomAndPosition);

        lightboxOverlay.addEventListener('wheel', handleLightboxWheel, { passive: false });

        function handleLightboxWheel(e) {
            // only when the lightbox is open
            e.preventDefault();               // stop the page itself from scrolling
            if (lightboxCurrentScale <= 0) {  // safety
                resetLightboxZoomAndPosition();
                return;
            }

            // e.deltaY < 0 when wheel-up (toward the user), > 0 when wheel-down
            const direction = e.deltaY < 0 ? 0.5 : -0.5;
            const newScale = lightboxCurrentScale + direction * ZOOM_STEP;

            setLightboxZoom(newScale);
        }

        let lastKnownMouseX = 0;
        let lastKnownMouseY = 0;
        let animationFrameRequested = false;

        lightboxImage.addEventListener('mousedown', (e) => {
            if (lightboxCurrentScale <= 1) return;
            lightboxIsDragging = true;
            lightboxImage.classList.add('grabbing');
            // Get current translation from transform
            const computedStyle = window.getComputedStyle(lightboxImage);
            const transformMatrix = new DOMMatrix(computedStyle.transform);
            lightboxImgInitialX = transformMatrix.m41;
            lightboxImgInitialY = transformMatrix.m42;
            lightboxDragStartX = e.clientX;
            lightboxDragStartY = e.clientY;
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!lightboxIsDragging || lightboxCurrentScale <= 1) return;
            
            // Store the latest mouse position
            lastKnownMouseX = e.clientX;
            lastKnownMouseY = e.clientY;

            // Request an animation frame to update the transform, if one isn't already pending
            if (!animationFrameRequested) {
                requestAnimationFrame(updateImageTransformForDrag);
                animationFrameRequested = true;
            }
        });

        function updateImageTransformForDrag() {
            animationFrameRequested = false;
            if (!lightboxIsDragging) return;

            // How far we‚Äôve moved the mouse on screen
            const dxScreen = lastKnownMouseX - lightboxDragStartX;
            const dyScreen = lastKnownMouseY - lightboxDragStartY;

            // Convert that into image‚Äìspace (undo the scale)
            const dxImage = dxScreen / lightboxCurrentScale;
            const dyImage = dyScreen / lightboxCurrentScale;

            // Add it to the *unscaled* initial translation
            const newX = lightboxImgInitialX + dxImage;
            const newY = lightboxImgInitialY + dyImage;

            // **Translate first** (in raw px), then scale
            lightboxImage.style.transform =
                `translate(${newX}px, ${newY}px) scale(${lightboxCurrentScale})`;
        }


        document.addEventListener('mouseup', () => {
            if (lightboxIsDragging) {
                lightboxIsDragging = false;
                lightboxImage.classList.remove('grabbing');
            }
        });
        lightboxOverlay.addEventListener('mouseleave', () => { // Also stop dragging if mouse leaves overlay
            if (lightboxIsDragging) {
                lightboxIsDragging = false;
                lightboxImage.classList.remove('grabbing');
            }
        });

        function handleLightboxKeyPress(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
            if (e.key === '+') setLightboxZoom(lightboxCurrentScale + ZOOM_STEP);
            if (e.key === '-') setLightboxZoom(lightboxCurrentScale - ZOOM_STEP);
            if (e.key === '0') resetLightboxZoomAndPosition();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            fetchAlbums();
            updateComparisonDisplay();
        });
    </script>
</body>
</html>